<script>
    const GEMINI_API_KEY = 'AIzaSyBELzK5j4T6kss4ZQSz4OLB7OLX-Bo_WO4';  // Replace for testing only

    const board = document.getElementById('board');
    const commentary = document.getElementById('commentary');
    let cells = ['', '', '', '', '', '', '', '', ''];
    let gameOver = false;

    function renderBoard() {
        board.innerHTML = '';
        cells.forEach((cell, index) => {
            const cellDiv = document.createElement('div');
            cellDiv.classList.add('cell');
            cellDiv.textContent = cell;
            if (!gameOver) {
                cellDiv.onclick = () => handleMove(index);
            }
            board.appendChild(cellDiv);
        });
    }

    function handleMove(index) {
        if (cells[index] !== '' || gameOver) return;
        cells[index] = 'X';
        renderBoard();
        if (checkWin('X')) {
            commentary.textContent = 'You have won!';
            gameOver = true;
            return;
        }
        board.classList.add('disabled');
        requestAIMove();
    }

    function checkWin(player) {
        const wins = [
            [0,1,2],[3,4,5],[6,7,8],  // rows
            [0,3,6],[1,4,7],[2,5,8],  // columns
            [0,4,8],[2,4,6]           // diagonals
        ];
        return wins.some(combo => combo.every(idx => cells[idx] === player));
    }

    function getPositions(player) {
        const posNames = [
            'top left', 'top middle', 'top right',
            'middle left', 'center', 'middle right',
            'bottom left', 'bottom middle', 'bottom right'
        ];
        return cells
            .map((val, idx) => val === player ? posNames[idx] : null)
            .filter(val => val)
            .join(', ') || 'none';
    }

    async function requestAIMove() {
        const xPositions = getPositions('X');
        const oPositions = getPositions('O');

        const prompt = `
You are playing Tic Tac Toe as O. You are the best Tic Tac Toe player possible.

Current board:
X: ${xPositions}
O: ${oPositions}

If someone has won, respond ONLY:
"O WON"
or
"X WON"

Otherwise:
- Reply with your move position (like "middle left") as the first line.
- Reply with a short commentary as the second line.
`;

        commentary.textContent = 'AI is thinking...';

        const body = {
            contents: [{
                role: "user",
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(
                'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + GEMINI_API_KEY,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }
            );

            const data = await response.json();
            let aiResponse = '';

            if (data?.candidates?.[0]?.content?.parts?.[0]?.text) {
                aiResponse = data.candidates[0].content.parts[0].text.trim();
            } else {
                aiResponse = "ERROR: No valid response.";
            }

            if (aiResponse.includes('O WON') || aiResponse.includes('X WON')) {
                commentary.textContent = aiResponse.includes('O WON') ? 'AI has won!' : 'You have won!';
                gameOver = true;
                board.classList.remove('disabled');
                return;
            }

            const [moveLine, commentaryLine] = aiResponse.split('\n');
            const move = moveLine.trim().toLowerCase();
            const comment = commentaryLine ? commentaryLine.trim() : "Hmm... thinking...";

            applyAIMove(move);
            commentary.textContent = comment;

        } catch (error) {
            commentary.textContent = 'Error getting AI response.';
            console.error(error);
        }

        board.classList.remove('disabled');
    }

    function applyAIMove(position) {
        const posNames = [
            'top left', 'top middle', 'top right',
            'middle left', 'center', 'middle right',
            'bottom left', 'bottom middle', 'bottom right'
        ];

        const idx = posNames.indexOf(position);

        if (idx !== -1 && cells[idx] === '') {
            cells[idx] = 'O';
            renderBoard();
            if (checkWin('O')) {
                commentary.textContent = 'AI has won!';
                gameOver = true;
            }
        }
    }

    renderBoard();
</script>
